## 关于勒索病毒 Ransom:Win32.WannaCrypt 解决方案的最后一次说明

> 2017/5/12 晚，勒索软件 Ransom:Win32.WannaCrypt 大面积暴发。比病毒爆发更火的，则是各类关于此病毒的新闻、解决方法等在朋友圈等社交媒体的爆发。  

> 其中，有主观善意客观一知半解的知道，更有夹带私货的安全软件商携各类工具的广告宣传，以及各IT大小公司借此做些宣传。  

> 一时间，众多群众无所适从，战战兢兢；或者在自己的网络中将各种帖子所支招数悉数执行一遍，导致业务中断。
> 我在朋友圈中已多次发帖，探讨和指导应对。但依然看到大家的无所适从。  
为此，我整理一下思路，做最后一次说明。

>> 我是冯立超，2004-2017 微软最有价值专家MVP, 1998 以来微软认证系统工程师 MCSE, 2000 以来微软认证讲师 MCT。在2003-2004 微软可信赖计算全国巡讲签约讲师。本文不夹带私货，因为我已不卖微软产品多年，我现在的正事儿也不在此。只是从周六开始电话被打爆，才不得不忍痛停下手中的工作，被迫恋战于此。  
>> 此文只为给惶惑中的Windows用户们一些建议，以正视听。

![MVP](https://s5.51cto.com/wyfs02/M00/95/B8/wKioL1kZH8nB8xb7AAAdFuEaqlk733.gif)

### 主旨：
本文主要包括如下部分：  

> 1. 只须打补丁，只须打补丁，只须打补丁。
> 2. 不必使用360等自作聪明的工具及软件。
> 3. 不要随意关闭端口。

如果你听我的且不关心技术细节，可就此打住，干活人去吧。  

### 技术探讨
下面是一些相关技术问题：

#### 1. 只须打补丁！

**补丁概述**  

这次病毒是利用微软Windows SMB v1 的漏洞进行传播并远程执行代码，对计算机中的文档进行加密。  
病毒于 2017/5/12 大面积暴发。  
微软于 2017/3/14 发布了安全公告和安全更新。
链接地址：
[Microsoft 安全公告 MS17-010 - 严重](https://technet.microsoft.com/zh-cn/library/security/MS17-010)  
[MS17-010：Windows SMB 服务器安全更新](https://support.microsoft.com/zh-cn/help/4013389/title)  

**补丁解释**  
由于大家平常不看这样的微软官方技术文档，所以可能有些读不懂。不用担心，根据你的操作系统版本，选择相应的补丁即可。  
就用上面链接的第一个：安全公告为主来说吧：  
每一个操作系统下面，又有好几个链接，这又分几方面：  
- 操作系统小版本：操作系统的小版本。例如是否sp1 / sp2 等。  
- 系统平台：32位或是64位，或者少见的 Itanium 等。
- 针对本漏洞的更新或者月度汇总更新。  
以上前两个要选对。第三个看情况选。想短平快就选"仅用于安全更新"，想全面一些就选“月度汇总更新”  

仅此一页足矣。有朋友打电话过来说补丁装不上，就是因为没有选对。

**企业补丁管理**
企业当然不能向个人一样一台台打补丁。   
你需要一台补丁服务器。建议部署微软的 WSUS 服务。  
其基本原理就是：企业内部的所有客户机将更新源指向 WSUS 服务器，WSUS 服务器将更新源指向微软补丁服务器。  
根据企业规模及IT管理模式，WSUS服务器可以配置为层次结构，可以配置补丁分发策略，可以对补丁进行审批操作等。   
具体请参见[Windows Server Update Services 概述](https://technet.microsoft.com/zh-cn/library/hh852345(v=ws.11).aspx) ，此不赘述。哦，赘述一下，这个服务是免费的，（好像反而不好立项是吧），不过请专业的微软解决方案合作伙伴实施服务是收费的。

当然也可以使用第三方专业公司的补丁服务。可以是真正专业的产品或者上级指定的产品。

**不要随意关闭端口**  
除非你知道会发生什么，否则不要随意关闭端口。
以下节选自 比我上面吹的资历还深的朋友MVP胡浩的文章[抵抗勒索病毒的正确姿势——不要上来就封端口！](http://haohu.blog.51cto.com/2474833/1925783) 中的重点内容：  

> 刚刚过去的这个周末，朋友圈一定被勒索病毒刷屏了~  
> 看到一堆人告诉别人封锁135-139，445端口，作为一个修过无数AD复制问题，客户端无法登录或者使用域资源问题的老司机，我想问问，您真的知道这些端口是干嘛的么？
端口使用的官方网页请看这里： 
[Port Assignments for Well-Known Ports](https://technet.microsoft.com/en-us/library/cc959828.aspx)   
> 请仔细阅读和确认有关135，136，137，138，139，445端口的作用，如果不确定是否需要这些端口完成正常的域登录、访问域资源、DC间检测复制等等，请谨慎封锁端口！
> 最大的危害不在于立即出现的故障，而在于90天或者180天之后出现的大量AD复制错误，修复这些问题比你想想的更复杂。

#### 2. 不必使用360等自作聪明的工具及软件
**保持电脑干净**  
请不要受 360 等所谓安全公司的蛊惑，安装一堆乱七八糟的流氓软件。  
这次事件很清楚，微软知道了产品漏洞，并立即发布了补丁。两个月后，恶意黑客利用此漏洞开发出WannaCry病毒。  
我们只需要按微软建议打补丁即可。应为你用的是微软的Windows。
如果你用的是周鸿祎他们家的操作系统，那你当然用他们家的360，但现在不是。  
  
360们也不是一无是处，他们大致在做两件事：
- 第 0 件：抓住事件起哄，扩大知名度！所谓唯恐天下不乱是也。
- 第 1 件：帮你扫描漏洞，并帮你到微软网站下载补丁过来装。这是一件微软自己会做的事情。但不知为何太多的人以为这是360的专长。阳春白雪遇到下里巴人罢。
- 第 2 件：万一真被黑了，他们帮你找回。  
**怎么可能？！** 计算机技术发展到现在，加密技术是数学上证明的而不是骗傻子的。就是我另一篇文章所说 是把钱藏到险柜里而不是藏到床下袜子里。此不赘述。  
所以，真要被黑客攻击并被加密了，360不可能解开。  
**但也有一丝希望**，360们倒是想到了一个可能的解决之道：病毒将你的文档加密后存到电脑上，并将源文件删除。那么用360变种的删除文件恢复工具，有可能找回被删的没被加密的文件。但这不能保证全找到。  
所以，万一你中招了，最好的方式就是别乱动，找专业工具如360提供的或其它任何数据恢复工具修复。（别找我，这活儿我不接）。

**某些所谓安全软件的罪恶**   
我们相信国际专业的网络安全公司是优秀的、伟大的。  
但我们也看到一堆哗众取宠鼓噪吆喝的公司的恣意妄为。他们推出所谓电脑管家之类的工具，以优化性能、提升安全为名，关闭一些他们不懂的服务与端口，导致系统出现许多莫名其妙的问题。 
如果不是他们随意建议用户关闭自动更新服务、如果不是他们随意接管Wndows自带的反病毒软件 MSE 或 Defender，如果不是他们恣意接管Windows防火墙，事情何以至此？！  
如果永恒之蓝是始作俑者，那这些所谓的安全软件就是帮凶。  

**那我用什么杀毒？**
微软很早就推出了自己的杀毒软件。  
所以，你只需要打开自动更新，同时使用微软自带的杀毒软件，就够了。  
如果您是 Windows 7 用户，请安装 [Microsoft Security Essentials](https://support.microsoft.com/en-us/help/14210/security-essentials-download). 下载地址：
[Windows Vista/Windows 7 32-bit ](http://mse.dlservice.microsoft.com/download/1/E/D/1ED80C09-218B-44D7-B72D-E1451634E72D/zhcn/x86/mseinstall.exe)   

[Windows Vista/Windows 7 64-bit](http://mse.dlservice.microsoft.com/download/1/E/D/1ED80C09-218B-44D7-B72D-E1451634E72D/zhcn/amd64/mseinstall.exe)   

从 Windows 8 以后，操作系统里边已经自带了 Windows Defender，直接使用即可。  

Windows 自带的杀毒软件 Defender，自带的防火墙，自带的 Windows Update，默认都是打开的，正常运行的。  
所以，本来一切都好好的，直到你安装了类似360等流氓软件，他把一切都截获了，打乱了。唉！你要引流氓入家，怪得了谁呢。

#### 3. 不要随意关闭端口 
关于这个问题，胡浩的文章[抵抗勒索病毒的正确姿势——不要上来就封端口！](http://haohu.blog.51cto.com/2474833/1925783) 已经清楚说明了，此不赘述。  

我只想讲几个故事：
- 关于 135 端口  
> 很多人知道 RPC 使用 135 端口，所以，为了能够实现RPC通信，在防火墙上打开了135端口，结果发现RPC通信依然有问题。为什么？因为 RPC 通信不是使用的 135 端口，而是在通信发起时，利用135端口协商，双方商量一个1024到65535之间的某个任意未被使用的端口来进行通信。  
所以，无论是打开端口还是关闭端口，必须要搞清楚这个端口是干什么的，原理是什么。而不是简单的关关关，干脆把网线拔了算了。
- 关于DHCP服务
> 很多G企不许使用动态IP，于是，他们就通过组策略把 DHCP Client 服务停了。他不知道这个服务除了自动获取IP之外，还进行DNS客户端注册和更新。结果导致DNS服务器上的客户机记录老旧或自动清理。。
- 关于共享
> 还是这些G企，不许使用共享，包括强制关闭 Admin$, IPC$等，岂不知这些管理共享的本质意义，导致与策略复制故障等一系列问题。
所以，如果你的活动目录出了问题，先别给我打电话，先问问自己这几天又装什么安全软件了，有关什么端口或服务了。你是否真的了解了这个安全软件所做的操作的原理。



